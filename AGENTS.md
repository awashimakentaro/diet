# agents.md（最終・強化版 / v1）

> 本プロジェクトに関わるすべてのエージェントと実装者が、実装前に必ず読み遵守すべき最上位規約。
> Codex CLI を含む AI / 人間のいずれも、変更・実装・提案の前に本ファイルを確認すること。

---

## 0. 本ドキュメントの位置づけ

### 0.1 優先順位
- 本 `agents.md` は v1 における **最上位の行動規範・開発規約** であり、要件定義・設計・実装コードより常に優先される。
- 暗黙的・無断での無視や上書きを禁止する。必要な変更があれば必ず本ファイルに反映する。

### 0.2 改訂要件（v2 以降）
1. 改訂内容は **明示的** かつ **意図的** でなければならない。
2. 変更は必ずドキュメント化し、履歴として残すこと。
- `agents.md` は不変ではないが、宣言されたバージョンごとに最終的な権威を持つ。

---

## 1. エージェントの定義
- 「エージェント」とは、特定の責務を持ち、自律的に振る舞うソフトウェア構成要素（API ハンドラ、UI ロジック、解析ロジック、定期処理など）を指す。
- 人間はエージェントではなく、設計上の前提条件・制約として扱う。

---

## 2. 開発・実装ルール（最重要）
本セクションのルールは人間・AI を問わず強制適用であり、例外は存在しない。

### 2.1 ファイル単位のドキュメント化（必須）
- すべてのファイル先頭に、日本語で以下を必ず明記する：
  - ファイルの責務
  - 使用されるエージェント / 処理フロー
  - やらないこと（責務外）
  - 他ファイルとの関係
- 下記ヘッダを欠くファイルは未完成・未レビュー・実装違反とみなす。

```ts
/**
 * RecordInputAgent.ts
 *
 * 【責務】
 * 記録タブにおけるユーザー入力（テキスト・画像）を受け取り、
 * 解析エージェントへ受け渡す。
 *
 * 【使用箇所】
 * - RecordScreen から呼び出される。
 *
 * 【やらないこと】
 * - 栄養計算
 * - DB保存
 * - UI描画
 *
 * 【補足】
 * 入力の正規化のみを担当し、判断ロジックは持たない。
 */
```

### 2.2 関数・メソッド単位のドキュメント化（必須）
- すべての関数 / メソッドに日本語ドキュメントコメントを付与する。
- 必須記述：処理内容、呼び出し元、入力 / 出力の意味、副作用（状態変更・I/O 等）の有無。
- コメントが欠ける関数は未完成・未レビュー・実装違反と扱う。

### 2.3 SRP（単一責務原則）の厳守（絶対ルール）
- 1ファイル = 1責務、1クラス = 1役割、1関数 = 1処理。
- 以下の実装を禁止する：複数責務の混在、条件分岐による役割変化、「ついで」の処理追加、過度な汎用ユーティリティ化。
- 判断に迷った場合は常に分割を優先する。

### 2.4 SRP 違反の判断基準
- 関数名 / メソッド名に複数の動詞的意味が含まれる。
- 説明文に「〜しつつ」「場合によって」「ついでに」が頻出する。
- テスト観点が複数存在する。
- 呼び出し元が複数の意図を期待している。
- 上記のいずれかに該当した場合、必ずリファクタリング対象とする。

### 2.5 AI エージェントへの追加制約（Codex 等）
- ドキュメントコメントの省略禁止。
- SRP を理由とした分割を躊躇しないこと。
- 行数削減のための説明削除を禁止する。
- 仕様の推測補完は禁止。不明点は質問で解決する。
- 可読性と意図の明示をコード長より優先する。

---

## 3. エージェント一覧（v1）

### AnalyzeAgent
- 【責務】テキスト / 画像入力を解析し、食品構成を JSON で生成する。
- 【やらないこと】DB 保存、UI 操作。

### SaveMealAgent
- 【責務】編集済みメニューを履歴として保存する。

### HistoryAgent
- 【責務】日付別履歴の取得・編集・削除・一括削除を提供する。

### FoodLibraryAgent
- 【責務】単品食品・メニューの保存、編集、削除、再利用を扱う。

### SummaryAgent
- 【責務】当日の履歴から kcal / PFC 合計を算出する。

### GoalAgent
- 【責務】目標値の保存と、体格情報からの自動計算。

### NotificationAgent
- 【責務】0 時における過不足通知を制御する。

---

## 4. ルールの目的
- 将来の自分が即座に理解できる状態を保つ。
- Codex による設計逸脱や意味崩壊を防ぐ。
- 感情的・個人的価値を持つプロジェクトを破壊しない。
- 本プロジェクトは機能集合ではなく、設計思想を保存するための構造体である。

---
